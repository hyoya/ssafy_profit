<template>
  <div style="width:90%;">
    <!--pin img -->
    <div style="position:relative">
      <div style="position:absolute; top:-73px; right:-65px; z-index:3;">
        <!-- <img src="https://i.imgur.com/dSQEMtT.png" alt="g"/> -->
        <!-- <img src="https://i.imgur.com/gTQZzck.png" alt="gg" style="width:140px; -ms-transform: rotateY(180deg);-webkit-transform: rotateY(180deg); transform: rotateY(180deg);"/> -->
      </div>
    </div>


    <!--작업실 타이틀 -->
    <div style="position:relative; margin-bottom:80px;">
      <div style="position:absolute; top:-6px; right:34%; z-index:3;">
        <span class="display-2 white--text"><span class="fontYanolja">작 업 실 </span></span>
        <img src="https://i.imgur.com/5RTt9xP.png" alt="gg" style="width:40px;"/>
      </div>
    </div>

    <!-- 아무것도 없을때 -->
    <div v-if="proceedList.length==0 && completeList.length==0 && delList.length==0">
      <div>
        <p style="width:100%; text-align: center; padding: 20% 0; border-radius: 20px; background: white;" class="title  grey--text">
          <span class="fontDoHyeon ">
            현재 지원한 공고가 없습니다.<br/>
            <br/>
            외주 공고페이지 <v-chip color="primary" small><span class="fontJua">바로가기</span></v-chip> 에서<br/>
            외주공고를 찜하면 작업실에 등록됩니다.
          </span>
        </p>
      </div>
    </div>


    <!-- 작업중인 리스트 -->
    <div style="width:100%; margin-bottom:40px;" v-if="proceedList.length>0">

      <fieldset style="padding:20px; border:2px solid white; border-radius:10px; " justify-center >
        <legend align="center" class="white--text display-1">
          <span class="fontYanolja">&nbsp;진행중인 프로젝트&nbsp;</span>
        </legend>

        <v-layout row wrap style="margin:20px 0;" v-for="recruit in proceedList">
          <v-card outlined style="width:100%; padding:12px;">
            <div class="subtitle-1" v-if="!((recruit.UserComplete == 2 && recruit.CompanyComplete == 0)|| (recruit.UserComplete == 0 && recruit.CompanyComplete == 2) || (recruit.UserComplete == 1 || recruit.CompanyComplete == 1))">
              <span class="headline font-weight-bold">{{recruit.projectTitle}}</span>
              <span class="caption grey--text">&nbsp;{{recruit.companyId}}</span>
              <br/>
              <div style="display:block;">
                <p style="width:100%;" class="text-center display-1 purple--text">
                  D-{{recruit.projectTerm}}
                </p>
                <p style="width:100%;" class="text-center headline">
                  {{recruit.pay }}원
                </p>
              </div>
            </div>

            <div v-else>
              <span class="headline font-weight-bold">{{recruit.projectTitle}}</span>
              <span class="caption grey--text">&nbsp;{{recruit.companyId}}</span>
              <br/>
              <div style="display:block;">
                <p style="width:100%;" class="text-center title grey--text">
                  D-{{recruit.projectTerm}}3<br/>
                  {{recruit.pay}}
                </p>
              </div>
            </div>

            <div>
              <p style="width:100%;" class="text-center headline">
                <span  v-if="recruit.UserComplete == 2 && recruit.CompanyComplete == 0">
                  완료 처리되었습니다.<br/> 상대방의 처리를 기다리는중입니다.
                </span>
                <span v-if="recruit.UserComplete == 0 && recruit.CompanyComplete == 2">
                  상대방이 완료를 누른 상태입니다. 계약이 정상적으로 종료되었다면 완료를 눌러주세요.
                </span>
                <div v-if="recruit.UserComplete == 1">
                  <p> 유저 측의 사유로 파기된 계약입니다. </p>
                </div>
                <div v-if="recruit.CompanyComplete == 1">
                  <p> 기업 측의 사유로 파기된 계약입니다. </p>
                </div>
              </p>
            </div>

            <v-container>
              <v-layout row wrap>
                <v-spacer/>
                <div v-if="recruit.UserComplete == 0 && recruit.CompanyComplete == 0">
                  <v-btn @click="complete(recruit,recruit.CompanyComplete)" style="margin-right:3px;" outlined color="blue">완료</v-btn>
                  <v-btn @click="popContract(recruit)" style="margin-right:3px;" outlined color="orange">계약서</v-btn>
                  <v-btn @click="popChat(recruit)" style="margin-right:3px;" outlined color="orange">채팅창</v-btn>
                  <v-btn @click="cancel(recruit)" style="margin-right:3px;" outlined color="red">계약파기</v-btn>
                </div>
                <div v-if="recruit.UserComplete == 2 && recruit.CompanyComplete == 0">
                  <!-- <p> 완료 처리됨 : 상대방의 처리를 기다리는중</p> -->
                  <v-btn @click="popContract(recruit)" style="margin-right:3px;" outlined color="orange">계약서</v-btn>
                  <v-btn @click="popChat(recruit)" style="margin-right:3px;" outlined color="orange">채팅창</v-btn>
                </div>
                <div v-if="recruit.UserComplete == 0 && recruit.CompanyComplete == 2">
                  <!-- <p> 상대방이 완료를 누른 상태입니다. 계약이 정상적으로 종료되었다면 완료를 눌러주세요.</p> -->
                  <v-btn @click="complete(recruit,recruit.CompanyComplete)" style="margin-right:3px;" outlined color="blue">완료</v-btn>
                  <v-btn @click="popContract(recruit)" style="margin-right:3px;" outlined color="orange">계약서</v-btn>
                  <v-btn @click="popChat(recruit)" style="margin-right:3px;" outlined color="orange">채팅창</v-btn>
                </div>
                <div v-if="recruit.UserComplete == 1">
                  <p> 기업측의 사유로 파기된 계약입니다. </p>
                </div>
                <div v-if="recruit.CompanyComplete == 1">
                  <p> 기업측의 사유로 파기된 계약입니다. </p>
                </div>
              </v-layout>
            </v-container>

          </v-card>
        </v-layout>
      </fieldset>

    </div>

    <!-- 완료 리스트 -->
    <div style="width:100%; margin-bottom:40px;" v-if="completeList.length>0">
      <fieldset style="padding:20px; border:2px solid white; border-radius:10px; " justify-center >
        <legend align="center" class="white--text display-1">
          <span class="fontYanolja">&nbsp;완료&nbsp;</span>
        </legend>
        <v-layout row wrap style="margin:20px 0;" v-for="recruit in completeList">
          <v-card outlined style="width:100%; padding:12px;">
            <div class="subtitle-1" v-if="!((recruit.UserComplete == 2 && recruit.CompanyComplete == 0)|| (recruit.UserComplete == 0 && recruit.CompanyComplete == 2) || (recruit.UserComplete == 1 || recruit.CompanyComplete == 1))">
              <span class="headline font-weight-bold">{{recruit.projectTitle}}</span>
              <span class="caption grey--text">&nbsp;{{recruit.companyId}}</span>
              <br/>
              <div style="display:block;">
                <p style="width:100%;" class="text-center display-1 purple--text">
                  D-{{recruit.projectTerm}}
                </p>
                <p style="width:100%;" class="text-center title">
                  {{recruit.pay}}
                </p>
              </div>
            </div>

            <div v-else>
              <span class="headline font-weight-bold">{{recruit.projectTitle}}</span>
              <span class="caption grey--text">&nbsp;{{recruit.companyId}}</span>
              <br/>
              <div style="display:block;">
                <p style="width:100%;" class="text-center title grey--text">
                  D-{{recruit.projectTerm}}3<br/>
                  {{recruit.pay}}
                </p>
              </div>
            </div>

          </v-card>
        </v-layout>
      </fieldset>
    </div>

    <!-- 파기 리스트 -->
    <div style="width:100%" v-if="delList.length>0">
      <fieldset style="padding:20px; border:2px solid white; border-radius:10px; " justify-center >
        <legend align="center" class="white--text display-1">
          <span class="fontYanolja">&nbsp;파기&nbsp;</span>
        </legend>
        <v-layout row wrap style="margin:20px 0;" v-for="recruit in delList">
          <v-card outlined style="width:100%; padding:12px;">
            <div class="subtitle-1" v-if="!((recruit.UserComplete == 2 && recruit.CompanyComplete == 0)|| (recruit.UserComplete == 0 && recruit.CompanyComplete == 2) || (recruit.UserComplete == 1 || recruit.CompanyComplete == 1))">
              <span class="headline font-weight-bold">{{recruit.projectTitle}}</span>
              <span class="caption grey--text">&nbsp;{{recruit.companyId}}</span>
              <br/>
              <div style="display:block;">
                <p style="width:100%;" class="text-center display-1 purple--text">
                  D-{{recruit.projectTerm}}
                </p>
                <p style="width:100%;" class="text-center title">
                  {{recruit.pay}}
                </p>
              </div>
            </div>

            <div v-else>
              <span class="headline font-weight-bold">{{recruit.projectTitle}}</span>
              <span class="caption grey--text">&nbsp;{{recruit.companyId}}</span>
              <br/>
              <div style="display:block;">
                <p style="width:100%;" class="text-center title grey--text">
                  D-{{recruit.projectTerm}}3<br/>
                  {{recruit.pay}}
                </p>
              </div>
            </div>

          </v-card>
        </v-layout>
      </fieldset>
    </div>

  </div>
</template>

<script src="https://www.gstatic.com/firebasejs/3.6.2/firebase.js"></script>
<script>
import FirebaseService from "@/services/FirebaseService";
import Vue from "vue";
var firebase = require('firebase/app');
require('firebase/auth');
require('firebase/database');

export default {
  name: "Studio",
  components: {
  },
  data() {
    return {
      nowLevel : "",
      userid : "",
      userdata : "",
      myDibs : "",
      recruits : "",
      Dibs : [],
      proceedList:[],
      completeList : [],
      delList : [],
    };
  },
  mounted() {
    this.fetchData();
  },
  filters: {
    wonfilter: function (value) {
      if (!value) return ''
      // console.log(typeof(value), value,"asdasdasd")
      var arr = String(value).split('');
      var str = "";
      var cnt = 0;
      for(var i=arr.length-1; i>=0; i--) {
        if( cnt % 3 == 0 && cnt!==0 ) {
          str=","+str;
        }
        str = arr[i] + str;
        cnt++;
      }
      return str;
    }
  },
  methods: {
    async fetchData() {
      this.nowLevel = this.$session.get('level');
      this.userid = this.$session.get('session_id');
      this.$store.commit('setSession', this.userid)
      this.userdata = await FirebaseService.SELECT_Userdata(this.$session.get('session_id'));
      this.recruits = await FirebaseService.SELECT_RecruitInfo();
      var userProceedList = await FirebaseService.SELECT_UserProceedList(this.$session.get('session_id'));
      this.myDibs = this.userdata[0].dibs;
      for(var i in this.recruits) {
        if(this.myDibs.includes(this.recruits[i].id)){
          this.Dibs.push(this.recruits[i]);
        }
      }
      var allChatRoom="";
      firebase.database().ref('/chat/').once('value').then( snapshot => {
        allChatRoom = snapshot.val();
        this.completeList = [];
        this.delList = [];
        this.proceedList = [];
        for(var i in allChatRoom) {
          if ( allChatRoom[i].userId == this.$session.get('session_id') && allChatRoom[i].UserComplete == 2 && allChatRoom[i].CompanyComplete == 2) {
            this.completeList.push(allChatRoom[i]);
          } else if (allChatRoom[i].userId == this.$session.get('session_id') && (allChatRoom[i].UserComplete == 1 || allChatRoom[i].CompanyComplete == 1)) {
            this.delList.push(allChatRoom[i]);
          }
        }
        for(var j in userProceedList)
          for(var i in allChatRoom) {
            if ( allChatRoom[i].recruitPK == userProceedList[j] && allChatRoom[i].userId == this.$session.get('session_id') &&  allChatRoom[i].UserComplete !== 1 && allChatRoom[i].CompanyComplete !== 1 && ( allChatRoom[i].UserComplete !== 2 || allChatRoom[i].CompanyComplete !== 2 ) ) {
              this.proceedList.push(allChatRoom[i]);
              break;
          }
        }
      });
      firebase.database().ref('/chat/').on('value', snapshot => {
        allChatRoom = snapshot.val();
        this.completeList = [];
        this.delList = [];
        this.proceedList = [];
        for(var i in this.myDibs) {
          if ( this.myDibs[i].contract ) {
            this.myDibs.splice(i,1);
          }
        }
        for(var i in allChatRoom) {
          if ( allChatRoom[i].userId == this.$session.get('session_id') && allChatRoom[i].UserComplete == 2 && allChatRoom[i].CompanyComplete == 2) {
            this.completeList.push(allChatRoom[i]);
          } else if (allChatRoom[i].userId == this.$session.get('session_id') && (allChatRoom[i].UserComplete == 1 || allChatRoom[i].CompanyComplete == 1)) {
            this.delList.push(allChatRoom[i]);
          }
        }
        for(var j in userProceedList)
          for(var i in allChatRoom) {
            if ( allChatRoom[i].recruitPK == userProceedList[j] && allChatRoom[i].userId == this.$session.get('session_id') &&  allChatRoom[i].UserComplete !== 1 && allChatRoom[i].CompanyComplete !== 1 && ( allChatRoom[i].UserComplete !== 2 || allChatRoom[i].CompanyComplete !== 2 ) ) {
              this.proceedList.push(allChatRoom[i]);
              break;
          }
        }
        // console.log(this.proceedList);
        // console.log(this.delList);
        // console.log(this.completeList);
      });
    },
    complete(recruit,companyState) {
      this.$swal({
         title: '정말 계약을 완료하시겠습니까?',
         text: "한번 완료한 계약은 수정이 불가능합니다.",
         type: 'warning',
         showCancelButton: true,
         confirmButtonColor: '#3085d6',
         cancelButtonColor: '#d33',
         confirmButtonText: '완료',
         cancelButtonText: '취소',
        }).then((result) => {
         if (result.value) {
           this.$swal('프로젝트 완료!','성공적인 프로젝트이셨나요?','success')
           FirebaseService.UPDATE_RecruitCompleteByUser(recruit.recruitPK,"success",companyState)
           var dataRef = firebase.database().ref('/'+recruit.link);
           dataRef.update({
             UserComplete : 2,
           });
           window.reload();
         }
       })
    },
    cancel(recruit) {
      this.$swal({
         title: '정말 계약을 파기하시겠습니까?',
         text: "한번 파기한 계약은 수정이 불가능합니다.",
         type: 'warning',
         showCancelButton: true,
         confirmButtonColor: '#3085d6',
         cancelButtonColor: '#d33',
         confirmButtonText: '파기',
         cancelButtonText: '취소',
        }).then((result) => {
         if (result.value) {
           this.$swal('프로젝트 실패','프로젝트 계약이 파기되었습니다.','error')
           FirebaseService.UPDATE_RecruitCompleteByUser(recruit.recruitPK,"fail")
           var dataRef = firebase.database().ref('/'+recruit.link);
           dataRef.update({
             UserComplete : 1,
           });
           window.reload();
         }
       })
    },


    dib(recruit_id,index) {
      this.userdata[0].dibs.splice(this.userdata[0].dibs.indexOf(recruit_id),1);
      FirebaseService.UPDATE_userDibs(this.userdata[0].dibs, this.$session.get('session_id'));
      this.$swal(
        '찜 목록에서 삭제',
        '해당 공고가 찜목록에서 삭제되었습니다.',
        'success'
      )
      var link = (recruit_id+this.$session.get('session_id'));
      console.log(link,"링크!!!!!!!!!!!!!");
      var dataRef = firebase.database().ref('/chat/'+link);
      dataRef.remove();

      this.Dibs.splice(index,1);





    },


    popChat(ccode){
      this.createChatRoom(ccode);
      var curl = ccode.link
      window.open(
        "../" + curl,
        curl,
        "titlebar=no,status=no,toolbar=no,resizable=yes,top=20,left=500,width=972,height=633"
      );
    },

    popDibChat(ccode){
      this.createChatRoom(ccode);
      var curl = ccode.id+ this.$session.get('session_id');
      window.open(
        "../chat/" + curl,
        curl,
        "titlebar=no,status=no,toolbar=no,resizable=yes,top=20,left=500,width=972,height=633"
      );
    },
    async createChatRoom(recruit) {
      var nickname = this.$session.get('session_id');
      var exist = await this.existChatRoom(recruit,nickname);

      var ar1 = recruit.data.createDay.split('-');
      var ar2 = recruit.data.endDay.split('-');
      var da1 = new Date(ar1[0], ar1[1], ar1[2]);
      var da2 = new Date(ar2[0], ar2[1], ar2[2]);
      var dif = da2 - da1;
      var cDay = 24 * 60 * 60 * 1000;// 시 * 분 * 초 * 밀리세컨
      var user = await FirebaseService.SELECT_Userdata(nickname);
      var company = await FirebaseService.SELECT_CompanyInfo(recruit.data.companyId);

       var bud =  recruit.data.budget.split(',');
       var budget = "";
       for(var i in bud) {
         budget += bud[i];
       }
       budget = Number(budget);
      console.log(budget,"에산이에오!!!");
      console.log( user[0].phonenumber , " 유저핸드폰번호 저장될거" )
      console.log(company[0].address , "주소")
      console.log(recruit.data.chief , " 책임자")
      if ( !exist.res ) {
        // INIT CHATROOM

        firebase.database().ref('chat/'+recruit.id+nickname).set({
          link : 'chat/'+recruit.id+nickname,
          recruitPK : recruit.id,
          chatting : [{chatMsg:"<< SYSTEM >><br/>외주 공고 협의 채팅창입니다. <br/> 간이 계약서 패드를 활용하여 계약내용을 <br/> 조율하고 계약을 진행해보세요!",chatId:"!SYSTEM", isReadCompany : false, isReadUser : false},
        ],

          projectTitle : recruit.data.projectTitle,
          projectTerm : dif/cDay,
          pay : budget,
          downPayment : budget * 0.2,
          balance : budget - (budget * 0.2),
          penalty : recruit.data.penalty,
          contractDate : "",

          // company
          companyId : recruit.data.companyId,
          companyAddr : company[0].address,
          company : recruit.data.chief , //책임자

          //user
          phonenumber : user[0].phonenumber,
          userId : nickname,

          companyVerification : false,
          userVerification: false,
          UserComplete : 0,
          CompanyComplete : 0,

          isChangeProjectTerm : false,
          isChangePay : false,
          isChangeDownPayment : false,
          isChangePenalty : false,
          isChangeCompany : false,
          isChangePhonenumber : false,

        });
      }
    },

    async existChatRoom(recruit,nickname) {
      return firebase.database().ref('/chat/').once('value').then( snapshot => {
        var chats = snapshot.val();
        for(var i in chats) {
          if ( this.nowLevel == "2" ) {
            if ( chats[i].recruitPK == recruit.id && chats[i].userId == nickname ) {
              // console.log("유저접근 :: 이미 방이 존재하므로 바로 이동합니다.")
              return { res : true , index : chats[i] };
            }
          } else if ( this.nowLevel == "3" ) {
            if ( chats[i].recruitPK == recruit.id && chats[i].companyId == nickname ) {
              // console.log("회사접근 :: 이미 방이 존재하므로 바로 이동합니다.")
              return { res : true , index : chats[i] };
            }
          }
        }
        return { res : false };
      });
    },
    popContract(recruit){
      window.open(
        "../contract/" + recruit.recruitPK + '' + recruit.userId,
        recruit.recruitPK + '' + recruit.userId,
        "titlebar=no,status=no,toolbar=no,resizable=yes,top=20,left=500,width=1032,height=600"
      );
    },
  },

};

</script>
